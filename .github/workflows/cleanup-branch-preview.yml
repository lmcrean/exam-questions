name: Cleanup Branch Preview

on:
  pull_request:
    types: [closed]
  schedule:
    # Run daily at 2 AM UTC to clean up old deployments
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name to clean up (optional - leave empty to clean all old deployments)'
        required: false
        type: string

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  cleanup-on-pr-close:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: üßπ Clean up branch deployment
        run: |
          echo "üîç Cleaning up deployment for branch: ${{ github.head_ref }}"
          echo "PR #${{ github.event.number }} was closed"

          # Generate service names (matching your deployment pattern)
          BRANCH_SLUG=$(echo "${{ github.head_ref }}" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]' | cut -c1-63)
          API_SERVICE="api-${BRANCH_SLUG}"

          echo "üóëÔ∏è  Service to delete: ${API_SERVICE}"

      - name: üîê Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: ‚òÅÔ∏è Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: üóëÔ∏è Delete Cloud Run service
        run: |
          BRANCH_SLUG=$(echo "${{ github.head_ref }}" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]' | cut -c1-63)
          API_SERVICE="api-${BRANCH_SLUG}"

          echo "Deleting Cloud Run service: ${API_SERVICE}"
          gcloud run services delete ${API_SERVICE} \
            --region=europe-west2 \
            --project=dottie-app-37930 \
            --quiet || echo "Service ${API_SERVICE} not found or already deleted"

      - name: üóëÔ∏è Delete Firebase Hosting channel
        run: |
          BRANCH_SLUG=$(echo "${{ github.head_ref }}" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]' | cut -c1-63)

          echo "Deleting Firebase Hosting channel: ${BRANCH_SLUG}"

          # Install Firebase CLI if needed
          npm install -g firebase-tools

          # Delete the preview channel
          firebase hosting:channel:delete ${BRANCH_SLUG} --force || echo "Channel ${BRANCH_SLUG} not found or already deleted"
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

      - name: üí¨ Post cleanup confirmation
        uses: actions/github-script@v7
        with:
          script: |
            const branchSlug = "${{ github.head_ref }}".replace(/[^a-zA-Z0-9-]/g, '-').toLowerCase().slice(0, 63);

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.number }},
              body: `## üßπ Branch Deployment Cleaned Up

              The following resources have been deleted:
              - ‚òÅÔ∏è  Cloud Run service: \`api-${branchSlug}\`
              - üî• Firebase Hosting channel: \`${branchSlug}\`

              **Cost savings:** ~¬£1.50-3/month per service removed

              ---
              *Automatic cleanup triggered by PR closure*`
            });

  cleanup-old-deployments:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: üîê Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: ‚òÅÔ∏è Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: üîç Find and delete old deployments
        run: |
          echo "üîç Scanning for old branch deployments (older than 1 day)..."

          # Get current timestamp (1 day ago)
          CUTOFF_DATE=$(date -u -d '1 day ago' +%Y-%m-%dT%H:%M:%SZ)
          echo "Cutoff date: ${CUTOFF_DATE}"

          # List all Cloud Run services
          SERVICES=$(gcloud run services list \
            --project=dottie-app-37930 \
            --region=europe-west2 \
            --format="value(name,metadata.creationTimestamp)")

          # Services to keep (production services)
          KEEP_SERVICES="api-main|dottie-api-main"

          echo "Services that will be kept: ${KEEP_SERVICES}"
          echo ""
          echo "Checking all services..."

          DELETED_COUNT=0

          while IFS=$'\t' read -r SERVICE_NAME CREATED_AT; do
            # Skip if service name is empty
            if [ -z "$SERVICE_NAME" ]; then
              continue
            fi

            # Skip production services
            if echo "$SERVICE_NAME" | grep -E "^(${KEEP_SERVICES})$" > /dev/null; then
              echo "‚è≠Ô∏è  Skipping production service: ${SERVICE_NAME}"
              continue
            fi

            # Check if service is older than 1 day
            if [[ "$CREATED_AT" < "$CUTOFF_DATE" ]]; then
              echo "üóëÔ∏è  Deleting old service: ${SERVICE_NAME} (created: ${CREATED_AT})"

              gcloud run services delete ${SERVICE_NAME} \
                --region=europe-west2 \
                --project=dottie-app-37930 \
                --quiet

              DELETED_COUNT=$((DELETED_COUNT + 1))
            else
              echo "‚úÖ Keeping recent service: ${SERVICE_NAME} (created: ${CREATED_AT})"
            fi
          done <<< "$SERVICES"

          echo ""
          echo "üßπ Cleanup complete!"
          echo "Deleted ${DELETED_COUNT} old deployment(s)"
          echo "üí∞ Estimated savings: ¬£${DELETED_COUNT}.50-3/month"

      - name: üìä Generate cleanup report
        run: |
          echo "## Daily Cleanup Report - $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Remaining Services" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          gcloud run services list \
            --project=dottie-app-37930 \
            --region=europe-west2 \
            --format="table(name,metadata.creationTimestamp,status.url)" >> $GITHUB_STEP_SUMMARY
